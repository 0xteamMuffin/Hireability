generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

model User {
  id       String @id @default(cuid())
  email    String @unique
  username String @unique
  password String

  firstName String?
  lastName  String?
  bio       String?
  avatarUrl String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  profile              UserProfile?
  documents            Document[]
  targetCompanies      TargetCompany[]
  settings             UserSettings?
  interviews           Interview[]
  interviewTranscripts InterviewTranscript[]

  @@map("users")
}

model UserProfile {
  id     String @id @default(cuid())
  userId String @unique
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  targetRole    String?
  targetCompany String?
  level         String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("user_profiles")
}

model Document {
  id     String @id @default(cuid())
  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  type     DocumentType
  fileName String
  mimeType String?
  rawText  String?

  status     ProcessingStatus @default(PENDING)
  parsedData Json?
  review     String?

  agentVersion String?
  confidence   Float?
  tokenUsage   Int?
  processedAt  DateTime?
  error        String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("documents")
}

enum DocumentType {
  RESUME
  JOB_DESCRIPTION
  OTHER
}

enum ProcessingStatus {
  PENDING
  PROCESSING
  COMPLETED
  FAILED
}

model TargetCompany {
  id     String @id @default(cuid())
  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  companyName  String
  role         String
  companyEmail String?
  websiteLink  String?
  scrapedContent String? @db.Text
  scrapedAt    DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("target_companies")
}

model UserSettings {
  id     String @id @default(cuid())
  userId String @unique
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  notifications Boolean @default(true)
  darkMode      Boolean @default(false)
  language      String  @default("en")

  multiRoundEnabled    Boolean  @default(true)
  prerequisitesEnabled Boolean  @default(true)
  defaultRounds        String[] @default(["BEHAVIORAL", "TECHNICAL", "CODING"])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("user_settings")
}

model InterviewTranscript {
  id              String    @id @default(cuid())
  userId          String
  user            User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  interviewId     String
  interview       Interview @relation(fields: [interviewId], references: [id], onDelete: Cascade)
  assistantId     String?
  callId          String?
  startedAt       DateTime?
  endedAt         DateTime?
  durationSeconds Int?
  transcript      Json
  createdAt       DateTime  @default(now())

  @@map("interview_transcripts")
}

model Interview {
  id              String    @id @default(cuid())
  userId          String
  user            User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  assistantId     String?
  startedAt       DateTime  @default(now())
  endedAt         DateTime?
  durationSeconds Int?
  contextPrompt   String?
  callId          String?

  roundType  RoundType       @default(BEHAVIORAL)
  roundOrder Int             @default(1)
  sessionId  String?
  status     InterviewStatus @default(NOT_STARTED)

  createdAt DateTime @default(now())

  transcripts InterviewTranscript[]
  analysis    InterviewAnalysis?

  @@map("interviews")
}

model InterviewSession {
  id           String        @id @default(cuid())
  userId       String
  targetId     String?
  status       SessionStatus @default(IN_PROGRESS)
  currentRound Int           @default(1)
  totalRounds  Int           @default(2)
  completedAt  DateTime?
  createdAt    DateTime      @default(now())
  updatedAt    DateTime      @updatedAt

  rounds InterviewRound[]

  @@map("interview_sessions")
}

model InterviewRound {
  id          String           @id @default(cuid())
  sessionId   String
  session     InterviewSession @relation(fields: [sessionId], references: [id], onDelete: Cascade)
  interviewId String?

  roundType RoundType
  order     Int
  status    InterviewStatus @default(NOT_STARTED)
  isLocked  Boolean         @default(false)

  problemId      String?
  codeSubmission String?
  codeLanguage   String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("interview_rounds")
}

model CodingProblem {
  id          String     @id @default(cuid())
  title       String     @unique
  description String
  difficulty  Difficulty
  category    String
  starterCode Json?
  testCases   Json?
  hints       String[]
  solution    String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("coding_problems")
}

enum RoundType {
  BEHAVIORAL
  TECHNICAL
  CODING
  SYSTEM_DESIGN
  HR
}

enum InterviewStatus {
  NOT_STARTED
  IN_PROGRESS
  COMPLETED
  SKIPPED
}

enum SessionStatus {
  IN_PROGRESS
  COMPLETED
  ABANDONED
}

enum Difficulty {
  EASY
  MEDIUM
  HARD
}

model InterviewAnalysis {
  id             String    @id @default(cuid())
  interviewId    String    @unique
  interview      Interview @relation(fields: [interviewId], references: [id], onDelete: Cascade)
  technical      Json?
  problemSolving Json?
  communication  Json?
  roleKnowledge  Json?
  experience     Json?
  professional   Json?
  overall        Json?
  modelVersion   String?
  createdAt      DateTime  @default(now())

  @@map("interview_analysis")
}
